name: Documentation Check

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '.claude/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '.claude/**'

jobs:
  check-consistency:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make hooks executable
        run: chmod +x .claude/hooks/*.sh

      - name: Run requirements consistency check
        run: ./.claude/hooks/requirements-consistency-check.sh

      - name: Check for broken links in docs
        run: |
          # Markdownå†…ã®ãƒªãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          find docs -name "*.md" -exec grep -H '\[.*\](.*)' {} \; || true

      - name: Check documentation completeness
        run: |
          echo "ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯..."

          # å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å­˜åœ¨ç¢ºèª
          REQUIRED_DOCS=(
            "docs/design/database/overall-schema.md"
            "docs/design/api/endpoints.md"
            "docs/design/architecture/system-architecture.md"
            "docs/project-management/implementation-phases.md"
            "docs/project-management/coding-standards.md"
          )

          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $doc"
              MISSING=$((MISSING + 1))
            else
              echo "âœ… $doc"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "âŒ $MISSING å€‹ã®å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo ""
          echo "âœ… å…¨ã¦ã®å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™"

      - name: Check TODO comments
        run: |
          echo "ğŸ” TODOã‚³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯..."

          # docsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®TODOã‚’æ¤œç´¢
          TODO_COUNT=$(grep -r "TODO\|FIXME\|\[è¨˜å…¥\]\|\[æ—¥ä»˜\]\|\[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" docs/ | wc -l || echo "0")

          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸  $TODO_COUNT å€‹ã®TODO/æœªè¨˜å…¥é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            grep -rn "TODO\|FIXME\|\[è¨˜å…¥\]\|\[æ—¥ä»˜\]\|\[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" docs/ || true
          else
            echo "âœ… TODOãªã—"
          fi
